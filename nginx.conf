# default.conf - Otimizado para Cloudflare
map $remote_addr $is_cloudflare {
    ~^10\.189\.176\.   1;
    ~^173\.245\.48\.   1;
    ~^103\.21\.244\.   1;
    default 0;
}

server {
    listen 80;
    server_name dash.advogalia.com.br;
    
    # Para Cloudflare Tunnel, NÃO redirecione para HTTPS
    # O tunnel já cuida disso
    
    # Apenas aceitar conexões HTTP normais
    if ($request ~ "^\\x16\\x03") {
        # Silenciosamente rejeitar handshakes SSL na porta 80
        return 444;  # Fecha conexão sem resposta
    }
    
    root /var/www/html/public;
    index index.php;
    
    # Headers do Cloudflare
    add_header X-Content-Type-Options "nosniff";
    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-XSS-Protection "1; mode=block";
    
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }
    
    location ~ ^/index\.php(/|$) {
        fastcgi_pass laravel_app:9000;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include fastcgi_params;
        
        # Passar headers do Cloudflare para Laravel
        fastcgi_param HTTP_X_FORWARDED_FOR $http_cf_connecting_ip;
        fastcgi_param HTTP_X_FORWARDED_PROTO $scheme;
        fastcgi_param HTTP_CF_CONNECTING_IP $http_cf_connecting_ip;
        fastcgi_param HTTP_CF_IPCOUNTRY $http_cf_ipcountry;
        fastcgi_param HTTP_CF_RAY $http_cf_ray;
        fastcgi_param HTTP_CF_VISITOR $http_cf_visitor;

        fastcgi_param HTTPS on;
        fastcgi_param REQUEST_SCHEME https;
        fastcgi_param HTTP_X_FORWARDED_PROTO https;
        fastcgi_param HTTP_X_FORWARDED_SSL on;
        fastcgi_param SERVER_PORT 443;
        
        # Headers do Cloudflare
        fastcgi_param HTTP_CF_CONNECTING_IP $http_cf_connecting_ip;
        fastcgi_param HTTP_X_FORWARDED_FOR $http_cf_connecting_ip;
        
        # Garantir que o Laravel veja a URL correta
        fastcgi_param HTTP_HOST $http_host;
    }
    
    location ~ /\.(?!well-known).* {
        deny all;
    }
    
    # Não logar conexões do Cloudflare
    access_log off;
    error_log /var/log/nginx/error.log warn;
}